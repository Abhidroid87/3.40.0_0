import type { FirebaseConfig } from '../firebase';
import type { GeminiConfig } from '../ai/gemini';

type EnvRecord = Record<string, string | undefined>;

declare global {
  // eslint-disable-next-line no-var
  var __APP_ENV__: EnvRecord | undefined;
  interface ImportMeta {
    readonly env: Record<string, string>;
  }
}

const ENV_KEYS = {
  FIREBASE: {
    API_KEY: 'FIREBASE_API_KEY',
    AUTH_DOMAIN: 'FIREBASE_AUTH_DOMAIN',
    PROJECT_ID: 'FIREBASE_PROJECT_ID',
    STORAGE_BUCKET: 'FIREBASE_STORAGE_BUCKET',
    MESSAGING_SENDER_ID: 'FIREBASE_MESSAGING_SENDER_ID',
    APP_ID: 'FIREBASE_APP_ID'
  },
  GEMINI: {
    API_KEY: 'GEMINI_API_KEY',
    MODEL: 'GEMINI_MODEL'
  },
  API: {
    BASE_URL: 'API_BASE_URL'
  }
} as const;

function getEnvValue(key: string, prefix = ''): string | undefined {
  const fullKey = prefix ? `${prefix}_${key}` : key;
  const viteKey = `VITE_${fullKey}`;
  
  // Check process.env
  if (typeof process !== 'undefined' && process.env) {
    if (process.env[fullKey]) return process.env[fullKey];
    if (process.env[viteKey]) return process.env[viteKey];
  }
  
  // Check import.meta.env (Vite)
  try {
    if (import.meta?.env) {
      if (import.meta.env[fullKey]) return import.meta.env[fullKey];
      if (import.meta.env[viteKey]) return import.meta.env[viteKey];
    }
  } catch {
    // ignore if import.meta is not available
  }

  // Check global env (for environments like React Native)
  if (globalThis.__APP_ENV__) {
    const value = globalThis.__APP_ENV__[fullKey] || globalThis.__APP_ENV__[viteKey];
    if (value) return value;
  }
  
  return undefined;
}

export function buildFirebaseConfigFromEnv(): FirebaseConfig {
  return {
    apiKey: getEnvValue(ENV_KEYS.FIREBASE.API_KEY) || '',
    authDomain: getEnvValue(ENV_KEYS.FIREBASE.AUTH_DOMAIN) || '',
    projectId: getEnvValue(ENV_KEYS.FIREBASE.PROJECT_ID) || '',
    storageBucket: getEnvValue(ENV_KEYS.FIREBASE.STORAGE_BUCKET) || '',
    messagingSenderId: getEnvValue(ENV_KEYS.FIREBASE.MESSAGING_SENDER_ID) || '',
    appId: getEnvValue(ENV_KEYS.FIREBASE.APP_ID) || ''
  };
}

export function buildGeminiConfigFromEnv(): GeminiConfig {
  return {
    apiKey: getEnvValue(ENV_KEYS.GEMINI.API_KEY) || '',
    model: getEnvValue(ENV_KEYS.GEMINI.MODEL) || 'gemini-pro'
  };
}

export function readApiBaseUrlFromEnv(): string {
  return getEnvValue(ENV_KEYS.API.BASE_URL) || 'http://localhost:4000';
}